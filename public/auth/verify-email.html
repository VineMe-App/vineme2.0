<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Verification - VineMe</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }
        .container {
            text-align: center;
            padding: 2rem;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        h1 {
            margin: 0 0 0.5rem;
            font-size: 1.5rem;
        }
        p {
            margin: 0;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner"></div>
        <h1>Verifying your email...</h1>
        <p>Opening VineMe app...</p>
    </div>

    <script>
        // Handle SendGrid tracking URLs - extract the final destination
        function extractFinalUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Check if this is a SendGrid tracking URL
            // SendGrid tracking URLs have 'upn' parameter and redirect to final URL
            const upn = urlParams.get('upn');
            
            if (upn) {
                // This is a SendGrid tracking URL, try to extract the final destination
                // SendGrid typically redirects, so we'll wait for the redirect or check hash
                // For now, we'll check if there's a redirect parameter or try to follow the redirect
                const redirectUrl = urlParams.get('redirect') || urlParams.get('url');
                if (redirectUrl) {
                    // Decode and redirect to the final URL
                    try {
                        const decoded = decodeURIComponent(redirectUrl);
                        window.location.href = decoded;
                        return;
                    } catch (e) {
                        console.error('Error decoding redirect URL:', e);
                    }
                }
            }
            
            // Extract query parameters from URL (either direct or after SendGrid redirect)
            const accessToken = urlParams.get('access_token');
            const refreshToken = urlParams.get('refresh_token');
            const redirect = urlParams.get('redirect');
            const email = urlParams.get('email');
            const type = urlParams.get('type');
            
            // Build the deep link URL
            let deepLink = 'vineme://auth/verify-email';
            const params = new URLSearchParams();
            
            if (accessToken) params.append('access_token', accessToken);
            if (refreshToken) params.append('refresh_token', refreshToken);
            if (redirect) params.append('redirect', redirect);
            if (email) params.append('email', email);
            if (type) params.append('type', type);
            
            const queryString = params.toString();
            if (queryString) {
                deepLink += '?' + queryString;
            }
            
            // Try to open the app via deep link
            function openApp() {
                // Try deep link first
                window.location.href = deepLink;
                
                // Fallback: if app doesn't open within 2 seconds, show instructions
                setTimeout(() => {
                    document.body.innerHTML = `
                        <div class="container">
                            <h1>Open VineMe App</h1>
                            <p>If the app didn't open automatically, please:</p>
                            <ol style="text-align: left; max-width: 400px; margin: 1rem auto;">
                                <li>Make sure you have the VineMe app installed</li>
                                <li>Tap the button below to open the app</li>
                                <li>Or copy this link and open it manually</li>
                            </ol>
                            <a href="${deepLink}" style="display: inline-block; margin-top: 1rem; padding: 0.75rem 1.5rem; background: #fff; color: #667eea; text-decoration: none; border-radius: 8px; font-weight: 600;">Open VineMe App</a>
                        </div>
                    `;
                }, 2000);
            }
            
            // Start the redirect process
            openApp();
        }
        
        // Wait a moment for SendGrid to redirect, then extract final URL
        // SendGrid tracking URLs typically redirect immediately
        setTimeout(extractFinalUrl, 100);
        
        // Also try immediately in case we're already at the final URL
        extractFinalUrl();
    </script>
</body>
</html>

